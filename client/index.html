<!DOCTYPE html>
<html>
<head>
  <title>HTML5 Platformer Game</title>
  <link rel="shortcut icon" href="./icons/favicon.ico"/>
  <script>
      createjs = window;
  </script>
  <script type="text/javascript" src="./src/async.js"></script>

  <script src="./src/jquery.js"></script>
  <script src="./src/easeljs.js"></script>
  <script src="./src/socket.io.js"></script>
  <script src="./src/bootstrap.js"></script>
  <script src="./src/bootstrap-colorpicker.js"></script>
  <script src="./src/extensions.js"></script>

  <link href="./src/jquery-ui.css" rel="stylesheet" type="text/css" />
  <script src="./src/jquery-ui.min.js"></script>


  <script src="./src/easeljs/XNARectangle.js"></script>
  <script src="./src/easeljs/ContentManager.js"></script>
  <script src="./src/easeljs/Sprite.js"></script>
  <script src="./src/easeljs/ActorDefinition.js"></script>
  <script src="./src/easeljs/ProgrammableSprite.js"></script>
  <script src="./src/easeljs/PixelArtCanvas.js"></script>
  <script src="./src/easeljs/LibraryManager.js"></script>
  <script src="./src/easeljs/GameManager.js"></script>

  <script src="./src/underscore.js"></script>
  <script src="./src/angular.js"></script>
  <script src="./src/angular/directives.js"></script>
  <script src="./src/angular/rules_controller.js"></script>
  <script src="./src/angular/pixel_art_controller.js"></script>
  <script src="./src/angular/library_controller.js"></script>

  <link href="/css/bootstrap.min.css" rel="stylesheet" media="screen">
  <link href="/css/editor.css" rel="stylesheet" media="screen">
  <link href="/css/colorpicker.css" rel="stylesheet" media="screen">

  <script>
  function start() {
		//find canvas and load images, wait for last image to load
		var canvas = document.getElementById("platformerCanvas");
		stage = new Stage(canvas);

    //find canvas and load images, wait for last image to load
    renderingCanvas = document.getElementById("renderingCanvas");
    renderingStage = new Stage(renderingCanvas);

    // downloading all needed images ressources and preloading sounds & music
    window.Socket = io.connect(':4430', {secure: false});
    window.Socket.on('connect', function () {
        console.log('Socket.io Connection Established.');
        window.Socket.emit('auth', { username: 'default', password: '' })
        window.Game.load('level1')
    });
    window.Socket.on('disconnect', function () {
        console.log('Socket.io Connection Lost. Trying to reconnect...');
    });

    window.Game = new GameManager(stage, renderingStage);
    window.rootScope = angular.element('body').scope()
  }
  </script>
</head>

<body onload="start()" ng-app="App">

<div class="navbar navbar-inverse navbar-static-top">
  <div class="navbar-inner">
    <div class="container" style="width:1120px;margin:auto;">
      <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="brand" href="#">Kodako</a>
<!--       <div class="nav-collapse collapse">
        <ul class="nav">
          <li class="active"><a href="#">Home</a></li>
          <li><a href="#about">About</a></li>
          <li><a href="#contact">Contact</a></li>
        </ul>
      </div>
 -->    </div>
  </div>
</div>

<div class="container" style="width:1120px; margin:auto;">
  <div class="white-box" style="float:left;line-height:0;">
    <canvas droppable id="platformerCanvas" width="800" height="520" style="background-color:black">
      Your browser doesn't support HTML5 Canvas!
    </canvas>

    <div>
      <button class="btn btn-info">Stop</button>
      <button class="btn">Run</button>
      <button class="btn">Step Forward</button>
      <button class="btn">Step Back</button>
      <button class="btn">Reset</button>

      <div class="btn-group">
        <button class="btn btn-info">Slow</button>
        <button class="btn">Med.</button>
        <button class="btn">Fast</button>
      </div>
    </div>

  </div>

  <!-- Begin Rules Controller -->
  <script type="text/ng-template" id="rule_template.html">

    <ng-switch on="struct.type">

    <div ng-switch-when="group-event" class="rule-container event" >

      <div class="header">
        <div style="float:left; width:20px;">
          <div ng-class="circle_for_rule(struct)"></div>
          <div ng-click="toggle_disclosed(struct)" class="triangle {{struct.disclosed}}"></div>
        </div>

        <img class="icon" ng-src="/img/icon_event_{{struct.event}}.png"/>
        <div class="name">{{name_for_event_group(struct)}}</div>
      </div>
      <ul class="unstyled rules-list" ng-hide="struct.disclosed" sortable='{"connectWith":".rules-list"}'>
        <li ng-repeat="struct in struct.rules" ng-include="'rule_template.html'" data-id="{{struct._id}}"></li>
      </ul>
    </div>

    <div ng-switch-when="group-flow" class="rule-container group">
      <div class="header">
        <div style="float:left; width:20px;">
          <div ng-class="circle_for_rule(struct)"></div>
          <div ng-click="toggle_disclosed(struct)" class="triangle {{struct.disclosed}}"></div>
        </div>
        <select ng-model="struct.behavior" ng-options="key for (key,value) in flow_types" ng-change="save_rules()">
        </select>
        <input class="name" ng-model="struct.name" ng-blur="save_rules()"/>
      </div>
      <ul class="unstyled rules-list" ng-hide="struct.disclosed" sortable='{"connectWith":".rules-list"}'>
        <li ng-repeat="struct in struct.rules" ng-include="'rule_template.html'" data-id="{{struct._id}}"></li>
      </ul>
    </div>

    <div ng-switch-default class="rule-container rule" ng-show="!struct.type">
      <div class="zerospace"><div ng-class="circle_for_rule(struct)" style="position:relative;z-index:4;"></div></div>
      <div class="scenario">
        <img ng-src="{{scenario_before_url(struct)}}"/>
        <div class="arrow">-></div>
        <img ng-src="{{scenario_after_url(struct)}}"/>
      </div>

      <div ng-click="toggle_disclosed(struct)" class="triangle {{struct.disclosed}}"></div>
      <input class="name" ng-model="struct.name" ng-blur="save_rules()"/>

      <ul class="unstyled" ng-show="!struct.disclosed && actions_for_rule(struct).length">
        <li ng-repeat="action in actions_for_rule(struct)" class="action">
          <span class="condition-value">{{action}}</span>
        </li>
      </ul>
    </div>

    </ng-switch>

  </script>


  <div id="actor-box" class="white-box" style="float:right; width:280px;" ng-controller="RulesCtrl" ng-cloak>
    <ul class="nav nav-tabs">
      <li class="active"><a href="#rules" data-toggle="tab">Rules</a></li>
      <li><a href="#variables" data-toggle="tab">Variables</a></li>
    </ul>

    <div class="tab-content">
      <div class="tab-pane active" id="rules">
        <div ng-show="rules() == undefined" class="empty-message">
          Select an actor to view rules.
        </div>
        <div ng-show="rules().length == 0" class="empty-message">
          This actor doesn't have any rules. Create<br>
          a new rule by tapping the 'Record' icon.
        </div>
        <ul class="unstyled rules-list" sortable='{{sortable_attributes_for_rules_root()}}'>
          <li ng-repeat="struct in rules()" ng-include="'rule_template.html'" data-id="{{struct._id}}"></li>
        </ul>
      </div>

      <div class="tab-pane" id="variables">
        <ul class="unstyled">
          <li class="variable" ng-repeat="variable in variables()">
          </li>
        </ul>
      </div>
    </div>
    <!-- End Rules Controller -->
  </div>

  <!-- Begin Library Controller -->
  <div id="library" ng-controller="LibraryCtrl" ng-cloak>
    <div id="definitions" class="white-box" style="width:490px; float:left;">

      <div class="btn btn-mini" style="float:right;" ng-click="add_definition()"><i class="icon-plus"></i></div>
      <h4>{{library_name}}</h4>

      <div ng-show="definitions().length == 0" class="empty-message">
        You haven't defined any actors yet! Create a new actor by clicking the '+' icon.
      </div>
      <div ng-repeat="def in definitions()" ng-click="select_definition(def)" class="item {{class_for_definition(def)}}">
        <i draggable data-identifier="actor:{{def.identifier}}" style="{{css_for_sprite_frame(def)}}"></i>
        <input class="name" ng-model="def.name" ng-blur="save_definition(def)" />
      </div>


    </div>

    <div id="appearances" class="white-box" style="width:290px; float:left;">

      <div class="btn btn-mini" style="float:right;" ng-click="add_appearance()"><i class="icon-plus"></i></div>
      <h4>Appearances</h4>
      <div ng-show="appearances().length == 0" class="empty-message">
        Select an actor in your library to view it's appearances.
      </div>
      <div ng-repeat="(id,frames) in appearances()" class="item">
        <i draggable data-identifier="appearance:{{id}}" style="{{css_for_sprite_frame(selected_definition(), frames[0])}}" ng-dblclick="edit_appearance(id, frames[0])"></i>
        <input class="name" ng-blur="save_appearance_name($event)" data-identifier="{{id}}" value="{{name_for_appearance(id)}}" />
      </div>
    </div>

    <div style="clear:both;"></div>

    <div id="trashcan" droppable class="btn"><i class="icon-trash"></i></div>

  </div>
  <!-- End Library Controller -->
</div>


<!-- Begin Pixel Art Controller -->
  <div ng-controller="PixelArtCtrl" id="pixelArtModal" class="modal hide fade" tabindex="-1" role="dialog" aria-hidden="true" style="width:671px;" data-backdrop="static" ng-cloak>
    <div class="modal-header">
      <h3>Edit Appearance</h3>
    </div>
    <div class="modal-body" style="max-height:585px;">

      <div class="sidebar">

        <!-- Colors -->
        <div class="color-preview" style="background-color: {{canvas.toolColor}}"></div>
        <div ng-repeat="color in colors" class="btn color" data-color="{{color}}" ng-click="set_tool_color(color)">
          <i style="background-color: {{color}}"></i>
        </div>

        <div class="btn color" data-color="rgb(255, 146, 180)" data-color-format="rgb" id="cp1">
            <span class="add-on"><i></i></span>
        </div>

        <div class="divider"></div>

        <!-- Tools -->
        <div ng-repeat="tool in canvas.tools" class="btn tool icon" ng-click="set_tool(tool)">
          <img ng-src="/img/tool_{{tool.name}}.png"/>
        </div>

        <!-- Undo / Redo -->

        <div class="btn icon" ng-disabled="!canvas.canUndo()" ng-click="canvas.undo()"><img src="/img/icon_undo.png"></div><div class="btn icon" ng-disabled="!canvas.canRedo()" ng-click="canvas.redo()"><img src="/img/icon_redo.png"></div>

      </div>
      <div style="float:left; width:521px;">
        <canvas id="pixelArtCanvas" width="521" height="521">
        </canvas>
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
      <button class="btn btn-primary" data-dismiss="modal" ng-click="save_editor()">Save Changes</button>
    </div>
  </div>
</div>
<!-- End Pixel Art Controller -->


<!-- Offscreen Resources for Rendering / Debugging -->
<div style="display:none;">
  <canvas id="renderingCanvas" width="300" height="300" style="background-color:black">
    Your browser doesn't support HTML5 Canvas!
  </canvas>
</div>


</body>
</html>
